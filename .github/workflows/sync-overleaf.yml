name: Sync to Overleaf

on:
  push:
    branches: [main]
    paths:
      - 'analysis/paper/**'
      - 'analysis/output/**'

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Copy referenced outputs to paper
        run: |
          mkdir -p analysis/paper/tables analysis/paper/plots

          # Extract \input{...} references from all .tex files in paper/
          grep -roh '\\input{[^}]*}' analysis/paper/*.tex | sed 's/\\input{//;s/}//' | sort -u | while read ref; do
            filename=$(basename "$ref")
            # Add .tex extension if missing
            [[ "$filename" != *.* ]] && filename="${filename}.tex"
            src="analysis/output/tables/${filename}"
            if [ -f "$src" ]; then
              cp "$src" "analysis/paper/tables/"
              echo "Copied table: $filename"
            fi
          done

          # Extract \includegraphics{...} references from all .tex files in paper/
          grep -roh '\\includegraphics[^{]*{[^}]*}' analysis/paper/*.tex | grep -o '{[^}]*}' | tr -d '{}' | sort -u | while read ref; do
            filename=$(basename "$ref")
            src="analysis/output/plots/${filename}"
            if [ -f "$src" ]; then
              cp "$src" "analysis/paper/plots/"
              echo "Copied plot: $filename"
            fi
          done

      - name: Commit outputs locally
        run: |
          git add analysis/paper/tables/ analysis/paper/plots/ || true
          git diff --staged --quiet || git commit -m "Auto-copy referenced outputs for Overleaf"

      - name: Push to Overleaf
        env:
          OVERLEAF_GIT_TOKEN: ${{ secrets.OVERLEAF_GIT_TOKEN }}
        run: |
          git remote add overleaf https://git:${OVERLEAF_GIT_TOKEN}@git.overleaf.com/67b7ac1749a64b42e2d99e7c
          git fetch overleaf
          git subtree split --prefix=analysis/paper -b overleaf-split
          git push overleaf overleaf-split:master --force
