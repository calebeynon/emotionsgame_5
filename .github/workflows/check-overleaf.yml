name: Check Overleaf for edits

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Clone Overleaf repo
        env:
          OVERLEAF_GIT_TOKEN: ${{ secrets.OVERLEAF_GIT_TOKEN }}
        run: |
          git clone https://git:${OVERLEAF_GIT_TOKEN}@git.overleaf.com/67b7ac1749a64b42e2d99e7c /tmp/overleaf

      - name: Detect human commits since last sync
        id: detect
        run: |
          cd /tmp/overleaf

          # Find the most recent commit by GitHub Actions
          last_sync=$(git log --all --author="GitHub Actions" --format="%H" -1 || true)

          if [ -z "$last_sync" ]; then
            echo "No prior sync commit found — treating all commits as human edits"
            human_commits=$(git log --format="%h %s (%an, %ai)" --all)
          else
            # Find commits after the last sync that are NOT by GitHub Actions
            # Note: --invert-grep only inverts --grep, not --author, so we filter via tab-delimited author column
            human_commits=$(git log --format="%aN	%h %s (%an, %ai)" "${last_sync}..HEAD" \
              | grep -v "^GitHub Actions	" \
              | cut -f2- || true)
          fi

          if [ -n "$human_commits" ]; then
            echo "::warning::Overleaf has unmerged human edits"
            echo "$human_commits"
            echo "has_edits=true" >> "$GITHUB_OUTPUT"
            {
              echo "commits<<EOF"
              echo "$human_commits"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
          else
            echo "No unmerged Overleaf edits detected"
            echo "has_edits=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout repository
        if: steps.detect.outputs.has_edits == 'true'
        uses: actions/checkout@v4

      - name: Create issue for unmerged Overleaf edits
        if: steps.detect.outputs.has_edits == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMITS: ${{ steps.detect.outputs.commits }}
        run: |
          # Check for existing open issue with overleaf-sync label
          existing=$(gh issue list --label "overleaf-sync" --state open --json number --jq '.[0].number' -R "${{ github.repository }}" || true)

          if [ -n "$existing" ]; then
            echo "Open issue #${existing} already exists — skipping creation"
            exit 0
          fi

          cat > /tmp/issue_body.md <<'EOF'
          ## Overleaf has unmerged edits

          The scheduled check detected human commits on Overleaf that have not been merged into this repo. Future syncs will be **blocked** until these edits are merged.

          ### Commits on Overleaf since last sync

          ```
          EOF
          echo "$COMMITS" >> /tmp/issue_body.md
          cat >> /tmp/issue_body.md <<'EOF'
          ```

          ### How to merge

          ```bash
          git fetch overleaf master
          git subtree pull --prefix=analysis/paper overleaf master --squash
          rm -rf analysis/paper/tables analysis/paper/plots  # Action-managed dirs
          git push origin main
          ```

          After merging, close this issue. The next push to `main` will sync normally.

          > To force-sync without merging, run the sync workflow manually with **force = true**.
          EOF

          gh issue create \
            --title "Overleaf has unmerged edits — sync blocked" \
            --body-file /tmp/issue_body.md \
            --label "overleaf-sync" \
            -R "${{ github.repository }}"
