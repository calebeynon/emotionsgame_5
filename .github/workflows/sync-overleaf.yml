name: Sync to Overleaf

on:
  push:
    branches: [main]
    paths:
      - 'analysis/paper/**'
      - 'analysis/output/**'
  workflow_dispatch:
    inputs:
      force:
        description: 'Force sync even if Overleaf has unmerged edits'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  issues: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clone Overleaf repo
        env:
          OVERLEAF_GIT_TOKEN: ${{ secrets.OVERLEAF_GIT_TOKEN }}
        run: |
          git clone https://git:${OVERLEAF_GIT_TOKEN}@git.overleaf.com/67b7ac1749a64b42e2d99e7c /tmp/overleaf
          cd /tmp/overleaf
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Check for unmerged Overleaf edits
        id: guard
        run: |
          cd /tmp/overleaf

          # Find the most recent commit by GitHub Actions
          last_sync=$(git log --all --author="GitHub Actions" --format="%H" -1 || true)

          if [ -z "$last_sync" ]; then
            echo "No prior sync commit found — treating all commits as human edits"
            human_hashes=$(git log --format="%H" --all)
          else
            # Find commits after the last sync that are NOT by GitHub Actions
            human_hashes=$(git log --format="%aN	%H" "${last_sync}..HEAD" \
              | grep -v "^GitHub Actions	" \
              | cut -f2 || true)
          fi

          # Filter out empty commits (Overleaf autosaves with no actual changes)
          human_commits=""
          for hash in $human_hashes; do
            if [ -n "$(git diff-tree --no-commit-id -r "$hash")" ]; then
              human_commits="${human_commits}$(git log --format="%h %s (%an, %ai)" -1 "$hash")"$'\n'
            fi
          done
          human_commits=$(echo "$human_commits" | sed '/^$/d')

          if [ -n "$human_commits" ]; then
            echo "::warning::Overleaf has unmerged human edits"
            echo "$human_commits"
            echo "has_edits=true" >> "$GITHUB_OUTPUT"
            # Save commit list for issue body
            {
              echo "commits<<EOF"
              echo "$human_commits"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
          else
            echo "No unmerged Overleaf edits detected"
            echo "has_edits=false" >> "$GITHUB_OUTPUT"
          fi

          # Determine if it's safe to proceed
          force="${{ inputs.force }}"
          if [ "$force" = "true" ] || [ -z "$human_commits" ]; then
            echo "safe=true" >> "$GITHUB_OUTPUT"
          else
            echo "safe=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create issue for unmerged Overleaf edits
        if: steps.guard.outputs.has_edits == 'true' && inputs.force != true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMITS: ${{ steps.guard.outputs.commits }}
        run: |
          # Check for existing open issue with overleaf-sync label
          existing=$(gh issue list --label "overleaf-sync" --state open --json number --jq '.[0].number' -R "${{ github.repository }}" || true)

          if [ -n "$existing" ]; then
            echo "Open issue #${existing} already exists — skipping creation"
            exit 0
          fi

          cat > /tmp/issue_body.md <<'EOF'
          ## Overleaf has unmerged edits

          The sync workflow detected human commits on Overleaf that have not been merged into this repo. The sync was **blocked** to prevent overwriting those edits.

          ### Commits on Overleaf since last sync

          ```
          EOF
          echo "$COMMITS" >> /tmp/issue_body.md
          cat >> /tmp/issue_body.md <<'EOF'
          ```

          ### How to merge

          ```bash
          git fetch overleaf master
          git subtree pull --prefix=analysis/paper overleaf master --squash
          rm -rf analysis/paper/tables analysis/paper/plots  # Action-managed dirs
          git push origin main
          ```

          After merging, close this issue. The next push to `main` will sync normally.

          > To force-sync without merging, run the workflow manually with **force = true**.
          EOF

          gh issue create \
            --title "Overleaf has unmerged edits — sync blocked" \
            --body-file /tmp/issue_body.md \
            --label "overleaf-sync" \
            -R "${{ github.repository }}"

      - name: Sync paper files to Overleaf
        if: steps.guard.outputs.safe == 'true'
        run: |
          # Copy all paper files (excluding .git, Action-managed tables/ and plots/)
          rsync -av --delete \
            --exclude='.git/' \
            --exclude='tables/' \
            --exclude='plots/' \
            analysis/paper/ /tmp/overleaf/

          # Create output directories
          mkdir -p /tmp/overleaf/tables /tmp/overleaf/plots

          # Extract \input{...} references and copy matching tables
          grep -roh '\\input{[^}]*}' analysis/paper/*.tex | sed 's/\\input{//;s/}//' | sort -u | while read ref; do
            filename=$(basename "$ref")
            [[ "$filename" != *.* ]] && filename="${filename}.tex"
            src="analysis/output/tables/${filename}"
            if [ -f "$src" ]; then
              cp "$src" "/tmp/overleaf/tables/"
              echo "Copied table: $filename"
            fi
          done

          # Extract \includegraphics{...} references and copy matching plots
          grep -roh '\\includegraphics[^{]*{[^}]*}' analysis/paper/*.tex | grep -o '{[^}]*}' | tr -d '{}' | sort -u | while read ref; do
            filename=$(basename "$ref")
            src="analysis/output/plots/${filename}"
            if [ -f "$src" ]; then
              cp "$src" "/tmp/overleaf/plots/"
              echo "Copied plot: $filename"
            fi
          done

      - name: Push to Overleaf
        if: steps.guard.outputs.safe == 'true'
        run: |
          cd /tmp/overleaf
          git add -A
          git diff --staged --quiet || git commit -m "Sync from GitHub Actions"
          git push origin master

      - name: Fail if guard blocked sync
        if: steps.guard.outputs.safe == 'false'
        run: |
          echo "::error::Sync blocked — Overleaf has unmerged human edits. See the GitHub issue for merge instructions."
          exit 1
